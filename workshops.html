import pandas as pd
import firebase_admin
from firebase_admin import credentials, firestore
from datetime import datetime

# 🔹 الاتصال بـ Firebase
cred = credentials.Certificate("serviceAccountKey.json")
firebase_admin.initialize_app(cred)
db = firestore.client()

# 🔹 ملف الإكسل
file_path = "ورش عمل محاور ومواعيد.xlsx"
sheets = ["17 NOV 2025", "18 NOV 2025", "19 NOV 2025"]

# 🔹 مسح البيانات القديمة (اختياري)
for doc in db.collection("workshops").stream():
    doc.reference.delete()

def read_workshops(sheet_name):
    df = pd.read_excel(file_path, sheet_name=sheet_name)
    df.columns = df.columns.str.strip()  

    print(f"\n📌 Sheet: {sheet_name}")
    print("Available columns:", list(df.columns))  # 🟢 طباعة الأعمدة للتحقق

    # أسماء الأعمدة
    title_col = "title" if "title" in df.columns else "Unnamed: 1"
    topic_col = "topic" if "topic" in df.columns else "Unnamed: 2"
    date_col  = "date"  if "date" in df.columns else "اليوم"
    time_col  = "time"  if "time" in df.columns else "الوقت"

    workshops = []
    current = None

    for _, row in df.iterrows():
        if pd.notna(row[title_col]):  # بداية ورشة جديدة
            if current:
                workshops.append(current)

            # ✅ التاريخ
            date_value = None
            if date_col in df.columns and pd.notna(row[date_col]):
                try:
                    date_value = pd.to_datetime(row[date_col], dayfirst=True, errors="coerce")
                except:
                    date_value = None

            # ✅ الوقت
            time_value = ""
            if time_col in df.columns and pd.notna(row[time_col]):
                time_value = str(row[time_col]).strip()

            current = {
                "title": str(row[title_col]).strip(),
                "date": date_value,
                "time": time_value,
                "topics": [],
                "reserved": False
            }

        # ✅ المحاور
        if pd.notna(row[topic_col]) and current:
            current["topics"].append(str(row[topic_col]).strip())

    if current:
        workshops.append(current)

    return workshops

# 🔹 دمج كل الأوراق
all_workshops = []
for sheet in sheets:
    workshops = read_workshops(sheet)
    all_workshops.extend(workshops)

# 🔹 رفع على Firestore
for i, w in enumerate(all_workshops, start=1):
    db.collection("workshops").document(str(i)).set(w)

print(f"✅ تم رفع/تحديث {len(all_workshops)} ورشة إلى Firestore بنجاح")
input("اضغط Enter للخروج...")
